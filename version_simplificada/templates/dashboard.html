<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Procesador de Facturas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <!-- Header empresarial con logo -->
    <header class="app-header">
        <div class="container">
            <div class="header-brand">
                <img src="https://i.imgur.com/2pr7MD5.png" alt="Logo Empresa" class="app-logo">
                <div>
                    <h1>Procesador de Facturas</h1>
                    <div class="company-tagline">Gestión empresarial eficiente</div>
                </div>
            </div>
            <div class="user-info">
                <i class="fas fa-user-circle me-2"></i>
                {% if current_user.is_authenticated %}
                    {{ current_user.username }}
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm ms-2">
                        <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
                    </a>
                {% else %}
                    Sistema Demo
                {% endif %}
            </div>
        </div>
    </header>

    <main class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-invoice me-2"></i> Cargar Nuevas Facturas (PDF)
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="upload-area">
                            <form id="upload-form" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="file-upload" class="btn btn-danger">
                                        <i class="fas fa-upload me-1"></i> Subir Archivos
                                    </label>
                                    <input type="file" id="file-upload" class="d-none" accept=".pdf" multiple>
                                    <span id="selected-file" class="ms-2">Ningún archivo seleccionado</span>
                                </div>
                                
                                <div class="form-check form-check-inline mb-3">
                                    <input class="form-check-input" type="checkbox" id="pdf-optimizado" name="pdf_optimizado" checked>
                                    <label class="form-check-label" for="pdf-optimizado">PDF Optimizado</label>
                                </div>
                                
                                <!-- PDF Factura: oculto visualmente (se envía por defecto en background) -->
                                <input type="hidden" name="pdf_factura" value="on">
                                
                                <div class="mb-3">
                                    <button type="button" id="procesar-btn" class="btn btn-success">
                                        <i class="fas fa-cogs me-1"></i> Procesar Archivos
                                    </button>
                                </div>
                                
                                <div class="progress mb-3 d-none" id="upload-progress-container">
                                    <div id="upload-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-folder me-2"></i> Archivos Procesados y Historial
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Nombre Original</th>
                                        <th scope="col">Nombre Renombrado</th>
                                        <th scope="col">CUPS</th>
                                        <th scope="col">Dirección</th>
                                        <th scope="col">Tipo Gasto</th>
                                        <th scope="col">Fecha Factura</th>
                                        <th scope="col">Importe Total</th>
                                        <th scope="col">Comunidad</th>
                                        <th scope="col">Cuenta Contable</th>
                                        <th scope="col">Procesado</th>
                                        <th scope="col" style="width: 300px;">Movimiento Contable</th>
                                        <th scope="col" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for factura in facturas %}
                                    <tr>
                                        <td class="text-center">
                                            {% if factura.estado == 'success' %}
                                                <i class="fas fa-check-circle text-success" title="Datos completos"></i>
                                            {% elif factura.estado == 'warning' %}
                                                <i class="fas fa-exclamation-triangle text-warning" title="Faltan algunos datos"></i>
                                            {% else %}
                                                <i class="fas fa-times-circle text-danger" title="Datos incompletos"></i>
                                            {% endif %}
                                        </td>
                                        <td>{{ factura.nombre }}</td>
                                        <td>
                                            {% if factura.archivo_procesado %}
                                                <a href="/descargar/{{ factura.id }}" class="text-decoration-none text-success fw-bold" title="Descargar factura">
                                                    {{ factura.archivo_procesado }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ factura.cups or '-' }}</td>
                                        <td>{{ factura.direccion or '-' }}</td>
                                        <td>{{ factura.tipo or '-' }}</td>
                                        <td>{{ factura.fecha or '-' }}</td>
                                        <td>{{ factura.importe or '-' }}</td>
                                        <td>{{ factura.comunidad or '-' }}</td>
                                        <td>{{ factura.cuenta or factura.cuenta_contable or '-' }}</td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input class="form-check-input procesado-checkbox" 
                                                       type="checkbox" 
                                                       value="" 
                                                       id="procesado-{{ loop.index }}" 
                                                       data-factura-id="{{ factura.id }}"
                                                       {% if factura.procesado %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td><pre class="small">{{ factura.movimiento_contable or '-' }}</pre></td>
                                        <td class="text-center">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success copy-btn" data-factura-id="{{ factura.id }}" title="Copiar movimiento contable">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                                <button class="btn btn-sm btn-info view-btn" data-factura-id="{{ factura.id }}" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para mostrar información de movimiento contable -->
    <div class="modal fade" id="movimientoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Movimiento Contable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Cuenta Contable:</label>
                        <input type="text" class="form-control" id="modal-cuenta" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Número de Cuenta:</label>
                        <input type="text" class="form-control" id="modal-numero" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Importe:</label>
                        <input type="text" class="form-control" id="modal-importe" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Concepto:</label>
                        <input type="text" class="form-control" id="modal-concepto" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="copy-movimiento">
                        <i class="fas fa-copy me-1"></i> Copiar al Portapapeles
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <div class="container">
            <p class="text-center">Fecha: {{ now().strftime('%d/%m/%Y %H:%M:%S') }} - Procesador.com - <small>Test Site</small></p>
        </div>
    </footer>
    
    <!-- Modal para visualización de factura -->
    <div class="modal fade" id="viewFacturaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>Visualización de Factura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nombre de Archivo:</label>
                                <p id="modal-view-nombre"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Cuenta Contable:</label>
                                <p id="modal-view-cuenta"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Comunidad:</label>
                                <p id="modal-view-comunidad"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Fecha:</label>
                                <p id="modal-view-fecha"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Número:</label>
                                <p id="modal-view-numero"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Estado:</label>
                                <p id="modal-view-estado"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Precio:</label>
                                <p id="modal-view-precio"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tipo:</label>
                                <p id="modal-view-tipo"></p>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <div id="pdf-preview-loading" class="mb-3">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p>Cargando vista previa...</p>
                        </div>
                        <div id="pdf-preview-container" class="mb-3">
                            <img id="pdf-preview-image" src="" class="img-fluid border" alt="Vista previa de factura">
                        </div>
                        <div id="pdf-preview-controls" class="btn-group mb-2">
                            <button class="btn btn-sm btn-outline-primary" id="prev-page-btn" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                            <span class="btn btn-sm btn-outline-secondary" id="page-indicator">Página 1 de 1</span>
                            <button class="btn btn-sm btn-outline-primary" id="next-page-btn" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="copy-factura-modal">
                        <i class="fas fa-copy me-1"></i> Copiar Movimiento
                    </button>
                    <button type="button" class="btn btn-primary" id="download-factura-modal">
                        <i class="fas fa-download me-1"></i> Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast para notificaciones -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="liveToast" class="toast hide bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Procesador de Facturas</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Operación realizada con éxito
            </div>
        </div>
    </div>

    <!-- Footer empresarial -->
    <footer class="app-footer">
        <div class="container text-center">
            <p>&copy; {{ now().year }} Procesador de Facturas | Gestión empresarial profesional</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
